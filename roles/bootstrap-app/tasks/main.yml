---
- name: Clone Laravel project
  git:
    repo: "{{ repo_git_url }}"
    dest: "{{ app_work_dir }}"
    version: "{{ branch }}"
    accept_hostkey: yes
  tags: laravel

- name: Check for Composer
  stat:
    path: /usr/local/bin/composer
  register: composer_stat

# - name: Download Composer
#   script: scripts/install_composer.sh
#   when: not composer_stat.stat.exists

- name: Download Composer installer
  get_url:
    url: https://getcomposer.org/installer
    dest: /tmp/composer-installer.php
  when: not composer_stat.stat.exists  
  tags: composer

- name: Install Composer
  shell: php /tmp/composer-installer.php --install-dir=/usr/local/bin --filename=composer
  args:
    creates: /usr/local/bin/composer
  when: not composer_stat.stat.exists  
  tags: composer

# - name: Move Composer Globally
#   become: true
#   command: mv composer.phar /usr/local/bin/composer
#   when: not composer_stat.stat.exists

- name: Set permissions on Composer
  become: true
  file:
    path: /usr/local/bin/composer
    mode: "a+x"

- name: Check Composer version
  shell: sudo -u www-data composer --version
  register: composer_version_output
  tags: 
   - composer
   - composer_version

- debug:
    msg: "Composer version: {{ composer_version_output.stdout }}"
    # var: composer_version_output.stdout_lines
  tags: 
   - composer
   - composer_version

# - name: Set permissions
#   file:
#     path: "{{ app_work_dir }}"
#     state: directory
#     owner: www-data
#     group: www-data
#     recurse: yes
#   tags: laravel

# - name: Copy .env file
#   template:
#     src: .env.j2
#     dest: "{{ app_work_dir }}/.env"
#   tags: laravel

# - name: Download Composer installer
#   get_url:
#     url: https://getcomposer.org/installer
#     dest: /tmp/composer-setup.php

# - name: Install Composer
#   shell: php /tmp/composer-setup.php --install-dir=/usr/local/bin --filename=composer
#   args:
#     creates: /usr/local/bin/composer

# - name: Ensure /usr/local/bin is in the PATH
#   lineinfile:
#     path: /etc/profile
#     line: 'export PATH="$PATH:/usr/local/bin"'
#     create: yes

# - name: Source /etc/profile for all users
#   copy:
#     content: |
#       if [ -f /etc/profile ]; then
#         . /etc/profile
#       fi
#     dest: /etc/profile.d/composer.sh
#     mode: '0755'

# - name: Ensure Composer is installed
#   command: composer --version
#   register: composer_version

# - name: Install Dependencies with Composer
#   command: composer install
#   args:
#     chdir: /var/www/laravel
#   tags:
#     - composer

# - name: Ensure Composer is installed
#   command: composer --version
#   register: composer_version
#   changed_when: false
#   tags:
#     - check-composer

# - name: Display Composer version
#   debug:
#     msg: "Composer version: {{ composer_version.stdout }}"
#   tags:
#     - check-composer  



# - name: Install Dependencies with Composer
#   become: false
#   composer:
#     command: install
#     working_dir: "{{ app_work_dir }}"
#   tags: [ 'composer:install' ]  

# - name: Composer update
#   command:
#     cmd: composer update
#     chdir: /var/www/laravel

# - name: composer install
#   command:
#     cmd: composer install
#     chdir: /var/www/laravel
# - name: Ensure project directory ownership
#   file:
#     path: "{{ app_work_dir }}"
#     state: directory
#     owner: www-data
#     group: www-data
#     recurse: yes

# - name: Ensure vendor directory exists
#   file:
#     path: "{{ app_work_dir }}/vendor"
#     state: directory
#     owner: www-data
#     group: www-data
#     mode: '0755'

# - name: Run Composer install as www-data
#   shell: sudo -u www-data composer install
#   args:
#     chdir: "{{ app_work_dir }}"
#   tags: ['composer:install']

# - name: Check Composer version
#   command: composer --version
#   register: composer_version
#   changed_when: false
#   tags: composer_version

# - debug:
#     msg: "Composer version: {{ composer_version.stdout }}"

# - name: Generate Laravel key
#   command: php artisan key:generate
#   args:
#     chdir: "{{ app_work_dir }}"
#   tags: laravel

# - name: Set permissions
#   file:
#     path: "{{ app_work_dir }}"
#     state: directory
#     owner: www-data
#     group: www-data
#     recurse: yes
#   tags: laravel

# - include_tasks: tasks/laravel-key-generate.yml
#   tags:
#     - laravel-key-generate